var total=function(t){var e=[];return t.forEach(function(t,r){e[r]=0===r?t:e[r-1]+t}),e},namespace=function(t){var e=t.split("."),r=self;e.forEach(function(t){void 0===r[t]&&(r[t]={}),r=r[t]})};function asyncCallerThing(t){promise=jim.promise.create(function(e){e(t)})}namespace("jim.common.array"),jim.common.array=function(t,e){for(var r=[],n=0;n<t;n+=1)r[n]=e(n);return r},namespace("jim.worker.pool"),jim.worker.pool.create=function(t,e,r,n,a){function o(t,e,r){var n=t.shift();if(n){n.batchid=r;var o=n[a];o?e.postMessage(n,[o]):e.postMessage(n)}}var i,s,c=(s=e,function(t,e){for(var r=[],n=0;n<t;n+=1)r[n]=e(n);return r}(i=t,function(t){var e=new Worker(s);return r.length===i&&e.postMessage(r[t],[r[t][n]]),e})),u=0;return{consume:function(t,e,r){var n=0,a=t.length,i=u+=1;c.forEach(function(s){s.onmessage=function(s){var c=s.data;c.batchid===i&&(n+=1,o(t,this,i),e(c),n===a&&r(c))},o(t,s,i)})},terminate:function(){c.forEach(function(t){t.terminate()})}}},namespace("jim.colour"),jim.colour.create=function(t,e,r,n){return{r:t,g:e,b:r,a:n}},namespace("jim.coord"),jim.coord.create=function(t,e){return{x:t,y:e,distanceTo:function(t){return jim.coord.create(t.x-this.x,t.y-this.y)}}},namespace("jim.coord.translator"),jim.coord.translator.create=function(t,e){return{translateTo:function(r){return jim.coord.create(r.topLeft().x+(e.x-t.topLeft().x)*r.width()/t.width(),r.topLeft().y+(e.y-t.topLeft().y)*r.height()/t.height())}}},namespace("jim.coord.translator2"),jim.coord.translator2.create=function(){return{translateX:function(t,e,r,n,a){return r+n/e*(a-t)},translateY:function(t,e,r,n,a){return r+n/e*(a-t)}}},namespace("jim.rectangle"),jim.rectangle.create=function(t,e,r,n){var a,o,i,s,c,u,m,f,p=jim.coord.create,h=function(t){return void 0!==t};return h(t.w)?(a=t.x,o=t.y,i=t.w,s=t.h):h(t.x)?(a=t.x,o=t.y,i=e.x,s=e.y):(a=t,o=e,i=r,s=n),c=p(a,o),u=p(a+i,o),m=p(a,o+s),f=p(a+i,o+s),{x:c.x,y:c.y,topLeft:function(){return c},topRight:function(){return u},bottomRight:function(){return f},bottomLeft:function(){return m},width:function(t){return h(t)&&(u.x=c.x+t,f.x=c.x+t,i=t),i},height:function(t){return h(t)&&(m.y=c.y+t,f.y=c.y+t,s=t),s},difference:function(t){return jim.rectangle.create(a-t.x,o-t.y,i-t.width(),s-t.height())},resize:function(t,e){this.width(t),this.height(e)},at:function(t,e){var r=jim.coord.translator.create;return h(t.x)?r(this,t):r(this,jim.coord.create(t,e))},copy:function(){return jim.rectangle.create(a,o,i,s)},place:function(t,e){a=t,o=e,c.x=t,c.y=e,u.x=i+t,u.y=e,f.x=t+i,f.y=e+s,m.x=t,m.y=e+s},move:function(t,e){a+=t,o+=e,c.x+=t,c.y+=e,u.x+=t,u.y+=e,f.x+=t,f.y+=e,m.x+=t,m.y+=e},split:function(t){for(var e=[],r=s/t,n=0;n<t;n+=1){var a=c.y+n*r;e.push(jim.rectangle.create(c.x,a,i,r))}return e},translateFrom:function(t){var e=this;return{to:function(r){var n,a;return n=t.at(e.topLeft()).translateTo(r),a=t.at(e.bottomRight()).translateTo(r),jim.rectangle.create(n,n.distanceTo(a))}}}}},namespace("jim.common.imageExportProgressReporter"),jim.common.imageExportProgressReporter.create=function(t,e,r){var n=0,a=0,o=0,i=0,s=0;return t.listenTo(e,function(t){var e=parseInt(t);a=(n+=e)/(i*s)*100,o=Math.round(100*a)/100,r.innerText=o+"%",o>=100&&(n=0,a=0,r.innerText=o+"%")}),{reportOn:function(t,e){i=t,s=e}}},namespace("jim.common.timeReporter"),jim.common.timeReporter.create=function(t){var e,r=0;return{start:function(){r=(new Date).getTime();var n=function(){var e=Math.floor(((new Date).getTime()-r)/1e3);t.innerHTML=e};n(),e=setInterval(n,1e3)},stop:function(){clearInterval(e)}}},namespace("jim.interpolator"),jim.interpolator.create=function(){return{interpolate:function(t,e,r){return t+(e-t)*r}}},namespace("jim.common"),jim.common.round=function(t,e){for(var r=1,n=0;n<e;n+=1)r*=10;return Math.round(t*r)/r},namespace("jim.dom.functions"),jim.dom.functions.create=function(){var t="buttonSelected",e="iconSelected",r=function(t,e){t.className=t.className+" "+e},n=function(t,e){t.classList.remove(e)};return{addClass:r,removeClass:n,selectButton:function(e){r(e,t)},deselectButton:function(e){n(e,t)},selectIcon:function(t){t.classList.contains(e)||r(t,e)},deselectIcon:function(t){n(t,e)},hide:function(t){t.style.display="none"},show:function(t){t.style.display=""},setHtml:function(t,e){t.innerHTML=e},element:function(t){return document.getElementById(t)}}},namespace("jim.promise"),jim.promise.create=function(t){var e,r,n="pending",a={promise:!0,resolve:function(t){t&&t.promise?t.then(a.resolve):(n="resolved",r=t,e&&a.handle(e))},handle:function(t){if("pending"===n)e=t;else if(t.chainedFunction){var a=t.chainedFunction(r);t.resolve(a)}else t.resolve(r)},then:function(t){return jim.promise.create(function(e){a.handle({chainedFunction:t,resolve:e})})}};return t(a.resolve),a},namespace("jim.anim.fixedLength"),jim.anim.fixedLength.create=function(){return{drawFrames:function(t,e){var r=-1;return jim.promise.create(function(n){var a=function(){(r+=1)<=t?(e(r),window.requestAnimationFrame(a)):n("Anim Complete")};window.requestAnimationFrame(a)})}}},namespace("jim.message.supplier"),jim.message.supplier.create=function(t){var e=t||["Calculating Pixels","Examining dead areas","Reticulating splines","Wombling free"],r=0;return{next:function(){var t=e[r];return(r+=1)>=e.length&&(r=0),t}}},namespace("jim.anim.textBox"),jim.anim.textBox.create=function(t,e){var r=t.getContext("2d"),n=jim.message.supplier.create(e),a=13;!function e(){function o(e,r,n){e.clearRect(0,0,t.width,t.height),e.fillStyle="rgba(255,255,255,255)",e.fillText(m,r,n)}r.font="12px courier";var i,s,c,u,m=n.next(),f=jim.anim.fixedLength.create(),p=7*m.length,h=(t.width-p)/2,g=(i=r,s=40,c=t.width,u=h,function(t){var e=t,r=-2*Math.abs(u-c)/(s*s);o(i,c-((0-r*s)*e+.5*r*e*e),a)});f.drawFrames(40,g).then(function(){var t,e;(t=r,e=h,function(){o(t,e,a)})()}).then(function(){setTimeout(function(){var t,n,i,s;f.drawFrames(40,(t=r,n=40,i=h,s=0-p,function(e){var r=e,c=Math.abs(s-i);o(t,i-(0*r+2*c/(n*n)*.5*r*r),a)})).then(function(){e()})},15*p)})}()},namespace("jim.newMandelbrotPoint"),jim.newMandelbrotPoint.create=function(){var t=16,e=9007199254740991;function r(t,e,r,n,a,o,i){return{mx:t,my:e,x:r,y:n,iterations:a,histogramEscapedAt:o,imageEscapedAt:i}}function n(n,a,o,i,s,c,u){var m=s,f=c,p=o,h=0,g=0,l=u,d=0,x=0,v=0,y=!1;for(0!==u&&(y=!0);p>0&&0===g;)h++,(v=(d=m*m)+(x=f*f))<e&&(f=m*f*2+a,m=d-x+n),p-=1,0===l&&v>t&&(l=h),0===g&&v>e&&(g=h);return r(n,a,m,f,i+h,y?u:0===l?0:i+l,0===g?0:i+g)}return{calculate:n,calcObject:function(t,e,r){return n(t.mx,t.my,r,e,t.x,t.y,t.histogramEscapedAt)},input:function(t,e,n,a,o,i){return r(t,e,n,a,0,o,i||0)}}},function(){var t=/^[\s,#]+/,e=/\s+$/,r=0,n=Math,a=n.round,o=n.min,i=n.max;n.random;function s(c,p){if(c=c||"",p=p||{},c instanceof s)return c;if(!(this instanceof s))return new s(c,p);var h=function(r){var a={r:0,g:0,b:0},s=1,c=!1,p=!1;"string"==typeof r&&(r=function(r){r=r.replace(t,"").replace(e,"").toLowerCase();var n,a=!1;if(names[r])r=names[r],a=!0;else if("transparent"==r)return{r:0,g:0,b:0,a:0,format:"name"};if(n=l.rgb.exec(r))return{r:n[1],g:n[2],b:n[3]};if(n=l.rgba.exec(r))return{r:n[1],g:n[2],b:n[3],a:n[4]};if(n=l.hsl.exec(r))return{h:n[1],s:n[2],l:n[3]};if(n=l.hsla.exec(r))return{h:n[1],s:n[2],l:n[3],a:n[4]};if(n=l.hsv.exec(r))return{h:n[1],s:n[2],v:n[3]};if(n=l.hsva.exec(r))return{h:n[1],s:n[2],v:n[3],a:n[4]};if(n=l.hex8.exec(r))return{a:(o=n[1],m(o)/255),r:m(n[2]),g:m(n[3]),b:m(n[4]),format:a?"name":"hex8"};var o;if(n=l.hex6.exec(r))return{r:m(n[1]),g:m(n[2]),b:m(n[3]),format:a?"name":"hex"};if(n=l.hex3.exec(r))return{r:m(n[1]+""+n[1]),g:m(n[2]+""+n[2]),b:m(n[3]+""+n[3]),format:a?"name":"hex"};return!1}(r));"object"==typeof r&&(r.hasOwnProperty("r")&&r.hasOwnProperty("g")&&r.hasOwnProperty("b")?(h=r.r,g=r.g,d=r.b,a={r:255*u(h,255),g:255*u(g,255),b:255*u(d,255)},c=!0,p="%"===String(r.r).substr(-1)?"prgb":"rgb"):r.hasOwnProperty("h")&&r.hasOwnProperty("s")&&r.hasOwnProperty("v")?(r.s=f(r.s),r.v=f(r.v),a=function(t,e,r){t=6*u(t,360),e=u(e,100),r=u(r,100);var a=n.floor(t),o=t-a,i=r*(1-e),s=r*(1-o*e),c=r*(1-(1-o)*e),m=a%6;return{r:255*[r,s,i,i,c,r][m],g:255*[c,r,r,s,i,i][m],b:255*[i,i,c,r,r,s][m]}}(r.h,r.s,r.v),c=!0,p="hsv"):r.hasOwnProperty("h")&&r.hasOwnProperty("s")&&r.hasOwnProperty("l")&&(r.s=f(r.s),r.l=f(r.l),a=hslToRgb(r.h,r.s,r.l),c=!0,p="hsl"),r.hasOwnProperty("a")&&(s=r.a));var h,g,d;return x=s,x=parseFloat(x),(isNaN(x)||x<0||x>1)&&(x=1),s=x,{ok:c,format:r.format||p,r:o(255,i(a.r,0)),g:o(255,i(a.g,0)),b:o(255,i(a.b,0)),a:s};var x}(c);this._originalInput=c,this._r=h.r,this._g=h.g,this._b=h.b,this._a=h.a,this._roundA=a(100*this._a)/100,this._format=p.format||h.format,this._gradientType=p.gradientType,this._r<1&&(this._r=a(this._r)),this._g<1&&(this._g=a(this._g)),this._b<1&&(this._b=a(this._b)),this._ok=h.ok,this._tc_id=r++}function c(t,e,r){t=u(t,255),e=u(e,255),r=u(r,255);var n,a,s=i(t,e,r),c=o(t,e,r),m=s,f=s-c;if(a=0===s?0:f/s,s==c)n=0;else{switch(s){case t:n=(e-r)/f+(e<r?6:0);break;case e:n=(r-t)/f+2;break;case r:n=(t-e)/f+4}n/=6}return{h:n,s:a,v:m}}function u(t,e){var r;"string"==typeof(r=t)&&-1!=r.indexOf(".")&&1===parseFloat(r)&&(t="100%");var a,s="string"==typeof(a=t)&&-1!=a.indexOf("%");return t=o(e,i(0,parseFloat(t))),s&&(t=parseInt(t*e,10)/100),n.abs(t-e)<1e-6?1:t%e/parseFloat(e)}function m(t){return parseInt(t,16)}function f(t){return t<=1&&(t=100*t+"%"),t}s.prototype={toHsv:function(){var t=c(this._r,this._g,this._b);return{h:360*t.h,s:t.s,v:t.v,a:this._a}},toHsvString:function(){var t=c(this._r,this._g,this._b),e=a(360*t.h),r=a(100*t.s),n=a(100*t.v);return 1==this._a?"hsv("+e+", "+r+"%, "+n+"%)":"hsva("+e+", "+r+"%, "+n+"%, "+this._roundA+")"},toRgb:function(){return{r:a(this._r),g:a(this._g),b:a(this._b),a:this._a}}},s.equals=function(t,e){return!(!t||!e)&&s(t).toRgbString()==s(e).toRgbString()};var p,h,g,l=(h="[\\s|\\(]+("+(p="(?:[-\\+]?\\d*\\.\\d+%?)|(?:[-\\+]?\\d+%?)")+")[,|\\s]+("+p+")[,|\\s]+("+p+")\\s*\\)?",g="[\\s|\\(]+("+p+")[,|\\s]+("+p+")[,|\\s]+("+p+")[,|\\s]+("+p+")\\s*\\)?",{rgb:new RegExp("rgb"+h),rgba:new RegExp("rgba"+g),hsl:new RegExp("hsl"+h),hsla:new RegExp("hsla"+g),hsv:new RegExp("hsv"+h),hsva:new RegExp("hsva"+g),hex3:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex8:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/});"undefined"!=typeof module&&module.exports?module.exports=s:"function"==typeof define&&define.amd?define(function(){return s}):(namespace("jim"),jim.tinycolor=s)}(),namespace("jim.palette.colourNode");var nodeid=0;jim.palette.colourNode.create=function(t,e){nodeid+=1;var r=jim.tinycolor(t).toRgb();return r.a=255,{id:nodeid,hsv:t,rgb:r,position:e,setPosition:function(t){this.position=t},setColour:function(t){this.colour=t,this.hsv=this.colour.toHsv(),this.rgb=this.colour.toRgb(),this.rgb.a=255}}},namespace("jim.palette"),jim.palette.create=function(t){t&&t.listenTo(t.colourSelected,function(t){t.hue});var e=jim.palette.colourNode.create,r=function(t,e,r){return{h:t,s:e,v:r}},n=jim.tinycolor({r:253,g:193,b:27,a:255}).toHsv(),a=r(100,"0%","0%"),o=r(10,"0%","100%"),i=e(a,0),s=e(o,1),c=jim.interpolator.create().interpolate,u={r:0,g:0,b:0,a:0},m=(r(0,"100%","100%"),[e(o,0),e(n,.9),e(a,1)]);var f={colourAt:function(t){var e,r,n,a,o,f=m.length,p=i,h=s,g=u;for(o=0;o<f;o++)if((e=m[o]).position<=t&&(p=m[o]),e.position>t){h=e;break}return r=p.rgb,n=h.rgb,a=(t-p.position)/(h.position-p.position),g.r=c(r.r,n.r,a),g.g=c(r.g,n.g,a),g.b=c(r.b,n.b,a),g.a=255,g},addSpecificNode:function(t,n){m.push(e(r(t,"100%","100%"),n))},addNode:function(){var t,n,a,o,c=e((a=360*Math.random(),o=100*Math.random()+"%",r(a,o,"100%")),(t={position:0},(n=m.slice()).push(s),n.unshift(i),n.map(function(e){var r=t.position;return t.position=e.position,{start:r,end:e.position,gap:function(){return this.end-this.start},midPoint:function(){return this.start+this.gap()/2}}}).reduce(function(t,e){return t.gap()>e.gap()?t:e}).midPoint()));return m.push(c),this.sort(),c},removeNode:function(t){m=m.filter(function(e){return t.id!==e.id})},setNodes:function(t){m=t},getNodes:function(){return m},sort:function(){m.sort(function(t,e){return t.position-e.position})},fromNodeList:function(t){m=t.map(function(t){return e(t.colourDesc,t.position)}),f.sort()},toNodeList:function(){return m.map(function(t){return{position:t.position,colourDesc:t.hsv}})}};return f},namespace("jim.twoPhaseHistogram"),jim.twoPhaseHistogram.create=function(t){var e=0,r=new Uint32Array(t),n=t;return{add:function(t){t<n&&(r[t]+=1,e+=1)},percentEscapedBy:function(t){var n=r[t];return void 0===n?1:0===n?0:n/e},process:function(){for(var t=0,n=0;n<r.length;n+=1)r[n]||(r[n]=0),t+=r[n],r[n]=t;e=r[r.length-1]},get:function(t){return r[t]},setData:function(t,a){r=t,e=a,n=t.length},id:function(){},total:function(){return e},data:function(){return r}}},namespace("jim.colourCalculator"),jim.colourCalculator.create=function(){return{nu:function(t,e,r,n,a){return a(a(n(t*t+e*e))/r)/r},interpolate:jim.interpolator.create().interpolate,forPoint:function(t,e,r,n,a){var o,i,s,c,u,m,f=Math.log,p=Math.LN2;return o=(0,Math.floor)(u=r+1-f(f(t*t+e*e)/2/p)/p),c=u%1,i=n.percentEscapedBy(o),s=n.percentEscapedBy(o+1),m=this.interpolate(i,s,c),a.colourAt(m)},black:jim.colour.create(0,0,0,255)}},namespace("jim.mandelbrot.state"),jim.mandelbrot.state.create=function(t,e,r,n){var a=jim.rectangle.create,o=r,i=[],s=a(0,0,t-1,e-1),c={zoomTo:function(t){i.push(o.copy()),o=t.area().translateFrom(s).to(o),n.fire(n.extentsUpdate,o)},resize:function(t,e){s=a(0,0,t-1,e-1)},zoomOut:function(){i.length>0&&(o=i.pop(),n.fire(n.extentsUpdate,o))},notFullyZoomedOut:function(){return i.length>0},move:function(t,e){var r,a,i=(r=t,a=e,s.at(r,a).translateTo(o)).distanceTo(o.topLeft());o.move(0-i.x,0-i.y),n.fire(n.extentsUpdate,o)},getExtents:function(){return o},getLastExtents:function(){return 0===i.length?o:i[i.length-1]},setExtents:function(t){o=t,0,n.fire(n.extentsUpdate,o)}};return on(n.zoomOutAction,function(){c.zoomOut()}),on(n.zoomInAction,function(t){c.zoomTo(t)}),on(n.moveSetAction,function(t){c.move(t.x,t.y)}),c},namespace("jim.mandelbrot.escapeDistributionHistogram"),jim.mandelbrot.escapeDistributionHistogram.create=function(t,e){var r=0,n=0;return on(t.histogramUpdateReceivedFromWorker,function(a){var o={array:function(a){var o=a.update,i=a.currentIteration;1;for(var s=0,c=0;c<o.length;c+=1){s+=o[c];var u=i>n?r:e[i+c];e[i+c]=s+u}return r+=s,n=i,t.fire(t.morePixelsEscaped,r),new Uint32Array(e)}(a),total:r,currentIteration:a.currentIteration};t.fire(t.histogramUpdated,o)}),on(t.extentsUpdate,function(){e=new Uint32Array(25e4),r=0,n=0}),{}},namespace("jim.mandelbrot.pixelEscapeRateTracker"),jim.mandelbrot.pixelEscapeRateTracker.create=function(t){var e=0,r=0;function n(){t.fire(t.restart),r=0,e=0}on(t.zoomInAction,function(){n()}),on(t.zoomOutAction,function(){n()}),on(t.moveSetAction,function(){n()});on(t.morePixelsEscaped,function(n){r+=1,e!==n&&(r=0),e===n&&r>30&&n>28e3&&(t.fire(t.stop),!1,r=0,e=0),e=n})},namespace("jim.mandelbrot.imageRenderer"),jim.mandelbrot.imageRenderer.create=function(t,e,r,n){var a=e.getContext("2d"),o=a.getImageData(0,0,r,n),i=o.data;return on(t.renderImage,function(t){i.set(t.imgData,t.offset)}),on(t.andFinally,function(){a.putImageData(o,0,0)}),{}},namespace("jim.worker.msetProcessor"),jim.worker.msetProcessor.create=function(){var t=Math.floor,e=jim.newMandelbrotPoint.create();return{processSet:function(r,n,a,o,i,s,c){for(var u,m,f,p,h,g,l=0,d=0,x=i/700,v=0;v<s;v+=1)for(var y=0;y<i;y+=1)u=n.getPixel(y,v),h=y,(g=c)&&g[700*t(v/x)+t(h/x)]||0!==u.imageEscapedAt||(l=u.mx,d=u.my,m=u.x||0,f=u.y||0,p=u.histogramEscapedAt,u=e.calculate(l,d,o,a,m,f,p)),n.putPixel(u,y,v,l,d);return n}}},namespace("jim.uiWorker"),jim.uiWorker.create=function(){var t,e,r,n,a,o=jim.worker.msetProcessor.create(),i=jim.palette.create(),s=jim.colourCalculator.create(),c=jim.twoPhaseHistogram.create(0),u=jim.twoPhaseHistogram.create(0),m={mw:3,mh:4,mx:-1,my:0};var f={updateImageData:function(t,e,r,n,a,o,i,s){var c=4*(e*s+t),u=0!==r.imageEscapedAt?o.forPoint(r.x,r.y,r.imageEscapedAt,a,i):{r:0,g:0,b:0,a:255};n[c]=u.r,n[c+1]=u.g,n[c+2]=u.b,n[c+3]=u.a},updateHistogramData:function(t,e,r,n,a){0!==t.histogramEscapedAt&&t.histogramEscapedAt>=e&&t.histogramEscapedAt<e+r&&(this.histogramUpdate[t.histogramEscapedAt-e]+=1)},getPixel:function(t,e){var r=m.mx+t*m.stepX,n=m.my+e*m.stepY,a=e*this.width+t;return{x:this.xState[a],y:this.yState[a],histogramEscapedAt:this.escapeValues[a],imageEscapedAt:this.imageEscapeValues[a],mx:r,my:n}},putPixel:function(t,e,r,n,a){var o=r*this.width+e;this.xState[o]=t.x,this.yState[o]=t.y,this.escapeValues[o]=t.histogramEscapedAt,this.imageEscapeValues[o]=t.imageEscapedAt,this.updateHistogramData(t,this.currentIteration,this.iterations,e,r),this.updateImageData(e,r,t,this.imageData,this.histogramForColour,this.colour,this.palette,this.width)}};return{onmessage:function(p){var h,g,l=p.data,d=l.exportWidth*l.exportHeight,x=l.iterations,v=new Uint32Array(x),y=new Uint32Array(l.histogramDataBuffer),b=l.histogramTotal,j=l.offset;f.imageData=new Uint8ClampedArray(4*d),f.iterations=x,f.currentIteration=l.currentIteration,f.colour=s,f.histogramUpdate=v,t&&!l.extents||(g=d,t=new Float64Array(g),e=new Float64Array(g),r=new Uint32Array(g),n=new Uint32Array(g),a=!0,f.xState=t,f.yState=e,f.escapeValues=r,f.imageEscapeValues=n),l.extents&&(m=l.extents,f.width=l.exportWidth),l.paletteNodes&&i.fromNodeList(l.paletteNodes),f.palette=i,u.setData(y,b),f.histogramForColour=u,f.width=l.exportWidth,f.msg=l,f.msg.mx=m.mx,f.msg.my=m.my,f.msg.mw=m.mw,f.msg.mh=m.mh,o.processSet(m,f,l.currentIteration,x,l.exportWidth,l.exportHeight,void 0),postMessage(function(){h=new Uint32Array(f.escapeValues);var r={offset:j,batchid:l.batchid,histogramUpdate:f.histogramUpdate.buffer,imageDataBuffer:f.imageData.buffer,escapeValues:h.buffer,histogramTotal:c.histogramTotal,extraDataSent:!1,reset:a};return l.sendData&&(r.xState=t,r.yState=e,r.imageEscapeValues=f.imageEscapeValues,r.extraDataSent=!0),r}(),[f.imageData.buffer,f.histogramUpdate.buffer,h.buffer]),a=!1}}},namespace("jim.histogramexportworker"),jim.histogramexportworker.create=function(){var t,e;var r=jim.worker.msetProcessor.create;return{onmessage:function(n){var a=n.data,o=r(),i=a.maxIterations,s=a.exportWidth,c=a.exportHeight;t=new Float64Array(s*c),e=new Float64Array(s*c);var u,m,f,p,h;u=o.processSet(a,(p=(m=a).maxIterations,h=m.exportWidth,{histogramData:(f=p,new Uint32Array(new ArrayBuffer(4*(f+1)))),histogramTotal:0,getPixel:function(t,e){var r=m.mx+t*m.mw,n=m.my+e*m.mh;return{x:0,y:0,iterations:0,histogramEscapedAt:0,imageEscapedAt:0,mx:r,my:n}},putPixel:function(r,n,a,o,i){var s=r.histogramEscapedAt-0;0!==r.histogramEscapedAt&&(this.histogramTotal+=1);var c,u,m,f,g=h*a+n;t[g]=o,e[g]=i,this.histogramData[s]=(c=r,u=0,m=p,f=this.histogramData[s],0!==c.histogramEscapedAt&&c.histogramEscapedAt>=u&&c.histogramEscapedAt<u+m?f+1||1:0)}}),0,parseInt(i),s,c,[]);var g,l,d,x,v,y,b,j=(g=s*c,l=u.histogramTotal,d=!0,x=u.histogramData.buffer,v=t,y=e,(b=a).type="progressReport",b.event={msg:g},b.result={},b.result.progress=g,b.result.chunkComplete=d,b.result.histogramData=x,b.result.histogramTotal=l,b.result.mxValues=v,b.result.myValues=y,b);postMessage(j,[u.histogramData.buffer,t.buffer,e.buffer])}}},namespace("jim.imageexportworker"),jim.imageexportworker.create=function(){var t,e=jim.worker.msetProcessor.create,r=jim.palette.create();function n(n){var a,o,i,s=e(),c=n.exportWidth,u=n.exportHeight;a=s.processSet(n.extents,(o=n,i=jim.colourCalculator.create(),{imgData:new Uint8ClampedArray(o.exportHeight*o.exportWidth*4),getPixel:function(t,e){var r=o.extents,n=r.mx+t*r.stepX,a=r.my+e*r.stepY;return{x:0,y:0,iterations:0,histogramEscapedAt:0,imageEscapedAt:0,mx:n,my:a}},putPixel:function(e,n,a){var s=a*o.exportWidth+n,c=4*s,u=0!==e.imageEscapedAt?i.forPoint(e.x,e.y,e.imageEscapedAt,t,r):{r:0,g:0,b:0,a:255};this.imgData[c]=u.r,this.imgData[c+1]=u.g,this.imgData[c+2]=u.b,this.imgData[c+3]=u.a}}),0,n.maxIterations,c,u,n.deadRegions);var m,f,p,h=(m=n,f=a.imgData,(p={result:{}}).result.imgData=f.buffer,p.result.offset=m.offset,p.batchid=m.batchid,p);postMessage(h,[h.result.imgData])}return{onmessage:function(e){var a,o=e.data;o.updateHistogramData?(function(e){t=jim.twoPhaseHistogram.create(e.histogramSize);var r=new Uint32Array(e.histogramData);t.setData(r,e.histogramTotal)}(o),a=o,r.fromNodeList(a.paletteNodes)):n(o)}}};var uiWorker=jim.uiWorker.create(),histogramExportWorker=jim.histogramexportworker.create(),imageExportWorker=jim.imageexportworker.create();function messageOfType(t,e){return t.data.workerMessageType===e}onmessage=function(t){messageOfType(t,"uiworker")&&uiWorker.onmessage(t),messageOfType(t,"histogramexportworker")&&histogramExportWorker.onmessage(t),messageOfType(t,"imageexportworker")&&imageExportWorker.onmessage(t)};